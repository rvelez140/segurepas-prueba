# ============================================
# SecurePass - Docker Compose con Seguridad ISO 27001
# ============================================
# Implementa controles de seguridad según ISO 27001/27002:
# - A.12.6.1: Gestión de vulnerabilidades técnicas
# - A.13.1.1: Controles de red
# - A.14.2.5: Principios de ingeniería de sistemas seguros
# - A.18.1.3: Protección de registros
# ============================================

version: '3.8'

services:
  # ============================================
  # Base de Datos MongoDB
  # ISO 27001 - A.12.3.1: Copias de respaldo de la información
  # ============================================
  mongodb:
    image: mongo:7.0
    container_name: securepass-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DB_NAME:-securepass}
    ports:
      - "127.0.0.1:${MONGODB_PORT:-37849}:27017"  # Solo localhost - ISO A.13.1.1
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      - ./scripts/mongo-init:/docker-entrypoint-initdb.d:ro
    networks:
      - securepass-internal
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "-u", "${MONGO_ROOT_USER}", "-p", "${MONGO_ROOT_PASSWORD}", "--authenticationDatabase", "admin", "--quiet"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    # Seguridad: Limitar recursos - ISO A.12.1.3
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    # Seguridad: Usuario no-root donde sea posible
    security_opt:
      - no-new-privileges:true

  # ============================================
  # API Backend Node.js
  # ISO 27001 - A.14.2.5: Principios de ingeniería segura
  # ============================================
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    image: securepass-api:latest
    container_name: securepass-api
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: ${API_PORT:-48721}
      # Base de datos
      MONGODB_URI: mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongodb:27017/${MONGO_DB_NAME:-securepass}?authSource=admin
      # Autenticación
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      # Usuario administrador de fábrica
      ADMIN_EMAIL: ${ADMIN_EMAIL:-factory@securepass.local}
      ADMIN_USERNAME: ${ADMIN_USERNAME:-factory_admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-Factory@SecureP@ss2024!}
      ADMIN_NAME: ${ADMIN_NAME:-Administrador de Fábrica}
      # Servicios externos
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME:-}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY:-}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET:-}
      EMAIL_HOST: ${EMAIL_HOST:-smtp.gmail.com}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_USER: ${EMAIL_USER:-}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:52341}
      WEB_URL: ${WEB_URL:-http://localhost:52341}
      # Seguridad ISO 27001
      LOG_LEVEL: ${LOG_LEVEL:-info}
      AUDIT_LOG_RETENTION_DAYS: ${AUDIT_LOG_RETENTION_DAYS:-90}
      MAX_LOGIN_ATTEMPTS: ${MAX_LOGIN_ATTEMPTS:-5}
      LOCKOUT_DURATION_MINUTES: ${LOCKOUT_DURATION_MINUTES:-15}
    ports:
      - "127.0.0.1:${API_PORT:-48721}:48721"  # Solo localhost
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - securepass-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:48721/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
    # Seguridad: Limitar recursos
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    security_opt:
      - no-new-privileges:true
    # Seguridad: Solo lectura del sistema de archivos donde sea posible
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=100m

  # ============================================
  # Frontend Web React
  # ISO 27001 - A.14.1.2: Seguridad de servicios de aplicaciones
  # ============================================
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      args:
        REACT_APP_API: ${REACT_APP_API:-http://localhost:48721/api}
    image: securepass-web:latest
    container_name: securepass-web
    restart: unless-stopped
    environment:
      NODE_ENV: production
    ports:
      - "127.0.0.1:${WEB_PORT:-52341}:80"
    depends_on:
      - api
    networks:
      - securepass-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=50m
      - /var/cache/nginx:mode=1777,size=50m
      - /var/run:mode=1777,size=10m

  # ============================================
  # Nginx Reverse Proxy con SSL
  # ISO 27001 - A.13.1.1: Controles de red
  # ISO 27001 - A.10.1.1: Política de uso de controles criptográficos
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: securepass-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-8472}:80"
      - "${NGINX_HTTPS_PORT:-8473}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      api:
        condition: service_healthy
      web:
        condition: service_healthy
    networks:
      - securepass-internal
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M
    security_opt:
      - no-new-privileges:true

# ============================================
# Redes - ISO 27001 A.13.1.1: Controles de red
# ============================================
networks:
  securepass-internal:
    driver: bridge
    internal: false  # Permite acceso a internet para APIs externas
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16

# ============================================
# Volúmenes Persistentes
# ISO 27001 - A.12.3.1: Copias de respaldo de la información
# ============================================
volumes:
  mongodb_data:
    driver: local
    name: securepass_mongodb_data
  mongodb_config:
    driver: local
    name: securepass_mongodb_config
  nginx_logs:
    driver: local
    name: securepass_nginx_logs

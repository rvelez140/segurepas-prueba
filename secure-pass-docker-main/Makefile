# ==============================================
# SecurePass - Makefile
# Comandos simplificados para Docker
# ==============================================

.DEFAULT_GOAL := help
.PHONY: help start stop restart logs build clean migrate backup restore status shell-api shell-web shell-db dev prod up down

# Colores
GREEN  := $(shell tput -Txterm setaf 2)
YELLOW := $(shell tput -Txterm setaf 3)
BLUE   := $(shell tput -Txterm setaf 4)
RESET  := $(shell tput -Txterm sgr0)

## â€”â€” SecurePass Makefile â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
help: ## Mostrar esta ayuda
	@echo '${BLUE}SecurePass - Comandos Disponibles${RESET}'
	@echo ''
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  ${GREEN}%-15s${RESET} %s\n", $$1, $$2}'
	@echo ''

## â€”â€” Docker â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
start: ## Iniciar todos los servicios
	@echo '${BLUE}ğŸš€ Iniciando SecurePass...${RESET}'
	@chmod +x start.sh
	@./start.sh

stop: ## Detener todos los servicios
	@echo '${BLUE}â¹ï¸  Deteniendo SecurePass...${RESET}'
	@docker-compose down
	@echo '${GREEN}âœ“ Servicios detenidos${RESET}'

restart: ## Reiniciar todos los servicios
	@echo '${BLUE}ğŸ”„ Reiniciando SecurePass...${RESET}'
	@docker-compose restart
	@echo '${GREEN}âœ“ Servicios reiniciados${RESET}'

## â€”â€” Logs â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
logs: ## Ver logs de todos los servicios
	@docker-compose logs -f

logs-api: ## Ver logs solo del API
	@docker-compose logs -f api

logs-web: ## Ver logs solo del frontend
	@docker-compose logs -f web

logs-db: ## Ver logs solo de MongoDB
	@docker-compose logs -f mongodb

## â€”â€” Build â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
build: ## Reconstruir todas las imÃ¡genes
	@echo '${BLUE}ğŸ”¨ Construyendo imÃ¡genes...${RESET}'
	@docker-compose build
	@echo '${GREEN}âœ“ ImÃ¡genes construidas${RESET}'

build-nocache: ## Reconstruir sin cachÃ©
	@echo '${BLUE}ğŸ”¨ Construyendo imÃ¡genes (sin cachÃ©)...${RESET}'
	@docker-compose build --no-cache
	@echo '${GREEN}âœ“ ImÃ¡genes construidas${RESET}'

rebuild: ## Reconstruir e iniciar
	@make build
	@make start

## â€”â€” Desarrollo â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
dev: ## Iniciar en modo desarrollo
	@export NODE_ENV=development BUILD_TARGET=development && docker-compose up

prod: ## Iniciar en modo producciÃ³n
	@export NODE_ENV=production BUILD_TARGET=production && docker-compose up -d

## â€”â€” Base de Datos â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
migrate: ## Ejecutar migraciÃ³n multi-tenant
	@echo '${BLUE}ğŸ”„ Ejecutando migraciÃ³n...${RESET}'
	@docker-compose exec api npm run migrate
	@echo '${GREEN}âœ“ MigraciÃ³n completada${RESET}'

backup: ## Backup de MongoDB
	@echo '${BLUE}ğŸ’¾ Creando backup...${RESET}'
	@mkdir -p backups
	@docker-compose exec mongodb mongodump --out=/data/backup-$(shell date +%Y%m%d-%H%M%S)
	@echo '${GREEN}âœ“ Backup creado${RESET}'

restore: ## Restaurar Ãºltimo backup (requiere BACKUP_DATE)
	@echo '${BLUE}ğŸ“¥ Restaurando backup...${RESET}'
ifndef BACKUP_DATE
	@echo '${YELLOW}âš  Uso: make restore BACKUP_DATE=20240101-120000${RESET}'
else
	@docker-compose exec mongodb mongorestore /data/backup-$(BACKUP_DATE)
	@echo '${GREEN}âœ“ Backup restaurado${RESET}'
endif

## â€”â€” Shell â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
shell-api: ## Abrir shell en contenedor API
	@docker-compose exec api sh

shell-web: ## Abrir shell en contenedor Web
	@docker-compose exec web sh

shell-db: ## Abrir shell MongoDB
	@docker-compose exec mongodb mongosh

## â€”â€” Estado â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
status: ## Ver estado de servicios
	@echo '${BLUE}ğŸ“Š Estado de servicios:${RESET}'
	@docker-compose ps

ps: status ## Alias para status

health: ## Ver health de servicios
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

## â€”â€” Limpieza â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
clean: ## Limpiar contenedores y volÃºmenes (Â¡CUIDADO!)
	@echo '${YELLOW}âš ï¸  ADVERTENCIA: Esto borrarÃ¡ todos los datos${RESET}'
	@read -p "Â¿EstÃ¡s seguro? (escribir 'yes'): " confirm && [ "$$confirm" = "yes" ] || exit 1
	@docker-compose down -v
	@echo '${GREEN}âœ“ Limpieza completada${RESET}'

prune: ## Limpiar imÃ¡genes no usadas
	@echo '${BLUE}ğŸ§¹ Limpiando imÃ¡genes...${RESET}'
	@docker image prune -f
	@echo '${GREEN}âœ“ ImÃ¡genes limpiadas${RESET}'

## â€”â€” Testing â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
test: ## Ejecutar tests del API
	@docker-compose exec api npm test

test-watch: ## Ejecutar tests en modo watch
	@docker-compose exec api npm run test:watch

## â€”â€” InstalaciÃ³n â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
install: ## Primera instalaciÃ³n completa
	@echo '${BLUE}ğŸ“¦ Instalando SecurePass...${RESET}'
	@[ -f .env ] || cp .env.example .env
	@chmod +x start.sh stop.sh help.sh
	@docker-compose build
	@echo ''
	@echo '${GREEN}âœ“ InstalaciÃ³n completada${RESET}'
	@echo ''
	@echo '${YELLOW}âš ï¸  No olvides configurar .env con tus credenciales${RESET}'
	@echo ''
	@echo '${BLUE}PrÃ³ximo paso: make start${RESET}'
	@echo ''

## â€”â€” Monitoreo â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
stats: ## Ver uso de recursos
	@docker stats --no-stream

top: ## Ver procesos en contenedores
	@docker-compose top

## â€”â€” Atajos â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
up: start ## Alias para start
down: stop ## Alias para stop

## â€”â€” InformaciÃ³n â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
info: ## Mostrar informaciÃ³n del sistema
	@echo '${BLUE}â„¹ï¸  InformaciÃ³n del sistema${RESET}'
	@echo ''
	@echo 'Docker:'
	@docker --version
	@echo ''
	@echo 'Docker Compose:'
	@docker-compose --version
	@echo ''
	@echo 'Servicios corriendo:'
	@docker-compose ps
	@echo ''
	@echo 'Uso de disco:'
	@docker system df
	@echo ''

version: ## Ver versiÃ³n de SecurePass
	@echo '${GREEN}SecurePass v1.0.0${RESET}'
	@echo 'Multi-Tenant Access Control System'
